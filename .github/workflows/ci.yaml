name: CI

on:
  push:
    branches:
      - 'feature-*'
  pull_request:
    branches:
      - main
  schedule:
    - cron: '12 15 * * *'

jobs:
  sast:
    name: Análisis estático con Semgrep
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    container:
      image: semgrep/semgrep:latest

    steps:
      - uses: actions/checkout@v3
      - run: semgrep ci --code
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
  
  sca:
    name: Análisis de composición de software con Semgrep
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    container:
      image: semgrep/semgrep:latest

    steps:
      - uses: actions/checkout@v3
      - run: semgrep ci --supply-chain
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
  
  image-docker:
    name: Construcción de imagen Docker
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v3
      - name: Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Construir imagen Docker
        run: |
          docker build -t aplicacion:latest .
  
  trivy-scan:
    name: Escaneo de vulnerabilidades con Trivy
    runs-on: ubuntu-latest
    needs: image-docker

    steps:
      - name: Instalar Trivy
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: aplicacion:latest
          format: table
          exit-code: 1
          ignore-unfixed: true
          vuln-type: os,library
          severity: CRITICAL,HIGH